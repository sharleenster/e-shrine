<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>E-Shrine Scattered Candles v2</title>
  <style>
    :root {
      --candle-width: 120px;
    }
    html, body {
      margin: 0;
      height: 100%;
      background: #000;
      overflow: hidden;
      font-family: system-ui, sans-serif;
    }
    #stage {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    .candle {
      position: absolute;
      width: var(--candle-width);
      cursor: pointer;
      user-select: none;
      transition: transform .2s ease;
    }
    .candle:hover { transform: scale(1.06); }
  </style>
</head>
<body>
  <div id="stage"></div>

  <script>
    // ------- knobs you can tweak -------
    const NUM_CANDLES   = 12;      // total candles
    const AUTO_OUT_MS   = 15000;   // 15s flicker time, then auto extinguish
    const LIGHT_MS      = 3000;    // length of candle_light.gif
    const OUT_MS        = 2500;    // length of candle_out.gif
    const EDGE_PADDING  = 80;      // keep away from edges
    const JITTER_RATIO  = 0.25;    // how much random within each grid cell (0..0.49)
    // -----------------------------------

    const stage = document.getElementById('stage');

    // Per-candle state + timers
    const stateMap  = new WeakMap(); // 'off' | 'lighting' | 'on' | 'extinguishing'
    const timerMap  = new WeakMap(); // auto-out timeout id

    function extinguish(img) {
      // avoid double triggers
      if (stateMap.get(img) !== 'on') return;
      clearAutoTimer(img);
      img.src = 'candle_out.gif';
      stateMap.set(img, 'extinguishing');
      setTimeout(() => {
        img.src = 'static_candle.png';
        stateMap.set(img, 'off');
      }, OUT_MS);
    }

    function setAutoTimer(img) {
      clearAutoTimer(img);
      const id = setTimeout(() => extinguish(img), AUTO_OUT_MS);
      timerMap.set(img, id);
    }
    function clearAutoTimer(img) {
      const id = timerMap.get(img);
      if (id) { clearTimeout(id); timerMap.delete(img); }
    }

    function createCandle(x, y) {
      const img = document.createElement('img');
      img.src = 'static_candle.png';
      img.className = 'candle';
      img.style.left = `${x}px`;
      img.style.top  = `${y}px`;
      stage.appendChild(img);

      stateMap.set(img, 'off');

      img.addEventListener('click', () => {
        const state = stateMap.get(img);

        if (state === 'off') {
          img.src = 'candle_light.gif';
          stateMap.set(img, 'lighting');
          setTimeout(() => {
            img.src = 'candle_loop.gif';
            stateMap.set(img, 'on');
            setAutoTimer(img);                // üî• start 15s auto-extinguish
          }, LIGHT_MS);
        }
        else if (state === 'on') {
          extinguish(img);                    // click to extinguish early
        }
        // clicks are ignored during 'lighting' and 'extinguishing'
      });

      return img;
    }

    // Even ‚Äúscatter‚Äù: grid cells with a touch of randomness (no overlaps)
    function scatterCandlesGrid() {
      stage.innerHTML = ''; // clear previous candles

      const W = stage.clientWidth  - EDGE_PADDING * 2;
      const H = stage.clientHeight - EDGE_PADDING * 2;

      // choose grid size: square-ish
      const cols = Math.ceil(Math.sqrt(NUM_CANDLES));
      const rows = Math.ceil(NUM_CANDLES / cols);

      const cellW = W / cols;
      const cellH = H / rows;

      const jitterX = cellW * JITTER_RATIO;
      const jitterY = cellH * JITTER_RATIO;

      let i = 0;
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          if (i++ >= NUM_CANDLES) break;

          const centerX = EDGE_PADDING + c * cellW + cellW / 2;
          const centerY = EDGE_PADDING + r * cellH + cellH / 2;

          // jitter within cell
          const x = centerX + (Math.random()*2 - 1) * jitterX;
          const y = centerY + (Math.random()*2 - 1) * jitterY;

          const img = createCandle(x - parseInt(getComputedStyle(document.documentElement).getPropertyValue('--candle-width'))/2, y - 150); // rough vertical offset so flame sits nicely
        }
      }
    }

    // Debounced resize -> re-scatter to stay responsive
    let resizeId = null;
    window.addEventListener('resize', () => {
      clearTimeout(resizeId);
      resizeId = setTimeout(scatterCandlesGrid, 150);
    });

    // init
    scatterCandlesGrid();
  </script>
</body>
</html>
